<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login - Telegram Session Generator</title>
    <link rel="stylesheet" href="/session/static/style.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        #api_id:focus {
            border-color: #0056b3 !important;
            box-shadow: 0 4px 12px rgba(0,123,255,0.3) !important;
            transform: translateY(-1px);
        }
        #api_id:hover {
            border-color: #0069d9;
            box-shadow: 0 3px 10px rgba(0,123,255,0.2);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="logo">
                <i class="fab fa-telegram-plane"></i>
                <h1>Session Generator</h1>
            </div>
        </div>

        <div class="main-content">
            <div id="login-form">
                <div class="feature-card">
                    <h2>Interactive Login</h2>
                    <p>Enter your Telegram API credentials and phone number to generate a secure session.</p>
                    <p><small><i class="fas fa-info-circle"></i> Get your API credentials from <a href="https://my.telegram.org/apps" target="_blank">my.telegram.org/apps</a></small></p>

                    <form id="credentials-form">
                        <input type="hidden" id="token" value="{{ token }}">
                        
                        <div class="form-group">
                            <label for="api_id">API ID</label>
                            <input type="number" id="api_id" placeholder="12345678" required style="border: 2px solid #007bff; border-radius: 8px; padding: 12px; font-size: 16px; transition: all 0.3s ease; background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%); box-shadow: 0 2px 8px rgba(0,123,255,0.1);">
                            <small>Your API ID from my.telegram.org/apps</small>
                        </div>
                        
                        <div class="form-group">
                            <label for="api_hash">API Hash</label>
                            <input type="text" id="api_hash" placeholder="abcdef1234567890abcdef1234567890" required>
                            <small>Your 32-character API Hash</small>
                        </div>
                        
                        <div class="form-group">
                            <label for="phone_number">Phone Number (with country code)</label>
                            <input type="text" id="phone_number" placeholder="+12223334444" required>
                            <small>Include country code (e.g., +1 for US)</small>
                        </div>
                        
                        <div class="form-group" style="margin-top: 20px;">
                            <details id="proxy-details">
                                <summary style="cursor: pointer; font-weight: 600;">
                                    Proxy Settings (Optional)
                                </summary>
                                <div style="margin-top: 12px;">
                                    <small>If you're in a region where Telegram is blocked, you can use a proxy server.</small>
                                    
                                    <div class="form-group" style="margin-top: 10px;">
                                        <label for="proxy_host">Proxy Host</label>
                                        <input type="text" id="proxy_host" placeholder="proxy.example.com">
                                    </div>
                                    
                                    <div style="display: flex; gap: 10px;">
                                        <div class="form-group" style="flex: 1;">
                                            <label for="proxy_port">Port</label>
                                            <input type="number" id="proxy_port" placeholder="8080" min="1" max="65535">
                                        </div>
                                        <div class="form-group" style="flex: 1;">
                                            <label for="proxy_type">Type</label>
                                            <select id="proxy_type">
                                                <option value="http">HTTP</option>
                                                <option value="https">HTTPS</option>
                                                <option value="socks4">SOCKS4</option>
                                                <option value="socks5">SOCKS5</option>
                                            </select>
                                        </div>
                                    </div>
                                    
                                    <div class="form-group">
                                        <label for="proxy_username">Username (Optional)</label>
                                        <input type="text" id="proxy_username" placeholder="username">
                                    </div>
                                    
                                    <div class="form-group">
                                        <label for="proxy_password">Password (Optional)</label>
                                        <input type="password" id="proxy_password" placeholder="password">
                                    </div>
                                </div>
                            </details>
                        </div>
                        
                        <button type="submit" class="btn btn-primary">Send Verification Code</button>
                    </form>

                    <form id="code-form" style="display: none;">
                        <input type="hidden" id="phone_code_hash">
                        <div class="form-group">
                            <label for="code">Verification Code</label>
                            <input type="text" id="code" required>
                        </div>
                        <button type="submit" class="btn btn-primary">Submit Code</button>
                    </form>

                    <form id="password-form" style="display: none;">
                        <div class="form-group">
                            <label for="password">Two-Factor Authentication Password</label>
                            <input type="password" id="password" required>
                        </div>
                        <button type="submit" class="btn btn-primary">Submit Password</button>
                    </form>
                </div>
            </div>
        </div>
        <div class="footer">
            <p><i class="fas fa-lock"></i> Your credentials are not stored. They are used only to generate the session string.</p>
        </div>
    </div>

    <div id="loading-overlay" class="loading-overlay" style="display: none;">
        <div class="loading-content">
            <div class="spinner"></div>
            <p id="loading-text">Processing...</p>
        </div>
    </div>
    <div class="flash-messages" id="flash-messages"></div>

    <script>
        const credentialsForm = document.getElementById('credentials-form');
        const codeForm = document.getElementById('code-form');
        const passwordForm = document.getElementById('password-form');
        const token = document.getElementById('token').value;
        let phoneNumber, apiId, apiHash, proxyHost, proxyPort, proxyType, proxyUsername, proxyPassword;

        credentialsForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            showLoading('Sending verification code...');
            
            // Get form values
            apiId = parseInt(document.getElementById('api_id').value);
            apiHash = document.getElementById('api_hash').value.trim();
            phoneNumber = document.getElementById('phone_number').value.trim();
            proxyHost = document.getElementById('proxy_host').value.trim() || null;
            proxyPort = document.getElementById('proxy_port').value ? parseInt(document.getElementById('proxy_port').value) : null;
            proxyType = document.getElementById('proxy_type').value || 'http';
            proxyUsername = document.getElementById('proxy_username').value.trim() || null;
            proxyPassword = document.getElementById('proxy_password').value.trim() || null;
            
            // Basic validation
            if (!apiId || apiId < 1000) {
                showError('Please enter a valid API ID (should be 6-8 digits)');
                hideLoading();
                return;
            }
            
            if (!apiHash || apiHash.length !== 32) {
                showError('Please enter a valid API Hash (should be exactly 32 characters)');
                hideLoading();
                return;
            }
            
            // Normalize phone number
            if (phoneNumber) {
                const cleaned = phoneNumber.replace(/[^\d+]/g, '');
                phoneNumber = cleaned.startsWith('+') ? '+' + cleaned.replace(/\+/g, '') : cleaned;
            }
            
            if (!phoneNumber || !phoneNumber.startsWith('+') || phoneNumber.length < 8) {
                showError('Please enter a valid phone number with country code (e.g., +1234567890)');
                hideLoading();
                return;
            }
            
            try {
                const requestData = {
                    token,
                    api_id: apiId,
                    api_hash: apiHash,
                    phone_number: phoneNumber
                };
                
                // Add proxy settings if provided
                if (document.getElementById('proxy-details').open && proxyHost && proxyPort) {
                    requestData.proxy_host = proxyHost;
                    requestData.proxy_port = proxyPort;
                    requestData.proxy_type = proxyType;
                    if (proxyUsername) requestData.proxy_username = proxyUsername;
                    if (proxyPassword) requestData.proxy_password = proxyPassword;
                }
                
                const response = await fetch('/session/send_code', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestData)
                });
                
                const data = await response.json();
                hideLoading();

                if (data.status === 'code_sent') {
                    showSuccess(data.message);
                    document.getElementById('phone_code_hash').value = data.phone_code_hash;
                    credentialsForm.style.display = 'none';
                    codeForm.style.display = 'block';
                } else {
                    showError(data.message);
                }
            } catch (err) {
                hideLoading();
                showError('Network error. Please check your connection and try again.');
            }
        });

        codeForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            showLoading('Verifying code...');
            const code = (document.getElementById('code').value || '').trim();
            const phone_code_hash = document.getElementById('phone_code_hash').value;

            const ctrl = new AbortController();
            const tId = setTimeout(() => ctrl.abort(), 35000);
            let data;
            try {
                const response = await fetch('/session/submit_code', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ token, phone_number: phoneNumber, phone_code_hash, code }),
                    signal: ctrl.signal
                });
                data = await response.json();
            } catch (err) {
                hideLoading();
                if (err.name === 'AbortError') {
                    showError('Verification timed out. Please try again.');
                } else {
                    showError('Network error. Please try again.');
                }
                return;
            } finally {
                clearTimeout(tId);
                hideLoading();
            }

            if (data.status === 'success') {
                showSuccess('Session generated successfully! Redirecting...');
                // Store session token if provided and set cookie for server-side validation
                if (data.session_token) {
                    document.cookie = `session_token=${data.session_token}; path=/; SameSite=Lax`;
                }
                const redirectUrl = data.redirect_url || '/session/success';
                setTimeout(() => window.location.href = redirectUrl, 1000);
            } else if (data.status === '2fa_needed') {
                showSuccess(data.message);
                codeForm.style.display = 'none';
                passwordForm.style.display = 'block';
            } else {
                showError(data.message);
            }
        });

        passwordForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            showLoading('Verifying password...');
            const password = document.getElementById('password').value;

            const ctrl = new AbortController();
            const tId = setTimeout(() => ctrl.abort(), 35000);
            let data;
            try {
                const response = await fetch('/session/submit_password', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ token, password }),
                    signal: ctrl.signal
                });
                data = await response.json();
            } catch (err) {
                hideLoading();
                if (err.name === 'AbortError') {
                    showError('2FA timed out. Please try again.');
                } else {
                    showError('Network error. Please try again.');
                }
                return;
            } finally {
                clearTimeout(tId);
                hideLoading();
            }

            if (data.status === 'success') {
                showSuccess('Session generated successfully! Redirecting...');
                // Store session token if provided and set cookie for server-side validation
                if (data.session_token) {
                    document.cookie = `session_token=${data.session_token}; path=/; SameSite=Lax`;
                }
                const redirectUrl = data.redirect_url || '/session/success';
                setTimeout(() => window.location.href = redirectUrl, 1000);
            } else {
                showError(data.message);
            }
        });

        function showLoading(text) {
            document.getElementById('loading-text').textContent = text;
            document.getElementById('loading-overlay').style.display = 'flex';
        }

        function hideLoading() {
            document.getElementById('loading-overlay').style.display = 'none';
        }

        function showFlashMessage(message, type) {
            const container = document.getElementById('flash-messages');
            const div = document.createElement('div');
            div.className = `flash-message flash-${type}`;
            div.innerHTML = `<span>${message}</span><button onclick="this.parentElement.remove()">&times;</button>`;
            container.appendChild(div);
            setTimeout(() => div.remove(), 5000);
        }

        function showSuccess(message) {
            showFlashMessage(message, 'success');
        }

        function showError(message) {
            showFlashMessage(message, 'error');
        }
    </script>
</body>
</html>
